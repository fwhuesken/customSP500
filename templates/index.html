<!DOCTYPE html>
<html>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
th {
  cursor: pointer;
}

    </style>

    <body>      
        <h1>Build your custom S&P 500</h1>



          <label>Sectors</label>
          <select id="sector" class="form-control" onchange="filterSector()">
            <option value="all-sectors">All sectors</option>
            <option>Industrials</option>
            <option>Health Care</option>
            <option>Information Technology</option>
            <option>Communication Services</option>
            <option>Consumer Staples</option>
            <option>Consumer Discretionary</option>
            <option>Utilities</option>
            <option>Financials</option>
            <option>Materials</option>
            <option>Real Estate</option>
            <option>Energy</option>
          </select>
          <p></p>
          <label>Search for name</label>
        <input class="form-control" type="text" id="search" onkeyup="searchName()">

        <h3 id="positionCount"></h3>
        <span id="val"></span>


        <button id="selectAll">Select all</button>

        <button id="removeAll">Remove  all from selection</button>

        <!-- <button id="toJSON">Selection to JSON</button> -->

        <button id="weightSelection">Go to weighting</button>



        <table id="portfolio" class="table table-hover table-condensed">
            <thead>
              <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Sector</th>
                  <th>Weight in %</th>
                  <th>Include in selection</th>
    <!--              <th>Share in selection</th>   -->
              </tr>
            </thead>  
            <tbody>
            <tr>
                {% for row in rows %}
            
               <td>{{row["symbol"]}}</td>
               <td>{{row["name"]}}</td>
               <td>{{row["sector"]}}</td>
               <td>{{row["weight"]}}</td>
               <td><input type="checkbox" class="myCheckbox" id="include" value="include" checked></td>
    <!--         <td><div class="form-group">
                    <div class="input-group mb-3">
                      <input type="number" class="form-control" aria-label="">
                      <div class="input-group-append">
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div> -->
            </tr>
         {% endfor %}
          </tbody>
        </table>
    </body>
  <script>

      selectAllButton = document.getElementById("selectAll");
      selectAllButton.addEventListener("click", async function () {
        selectAll();
        await countPosition();
      })

      removeAllButton = document.getElementById("removeAll");
      removeAllButton.addEventListener("click", function () {
        deSelect();
      })

      toJSONButton = document.getElementById("toJSON");

      weightSelectionButton = document.getElementById("weightSelection");
      weightSelectionButton.addEventListener("click", function () {
        weighting();
      })
      

      function searchName() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById("portfolio");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }
      function totalPositions() {
        table = document.getElementById("portfolio");
        tr = table.getElementsByTagName("tr");
        positionCount = document.getElementById("positionCount");
        /* minus 2 for header and for loop */
        positionCount.innerHTML = "Currently selected number of positions: " + (tr.length - 2);
      }

      totalPositions();
      
      function filterSector() {
          var input, filter, table, tr, td, i, txtValue;
          input = document.getElementById("sector");
          filter = input.value;
          table = document.getElementById("portfolio");
          tr = table.getElementsByTagName("tr");
          console.log(filter)

          // Loop through all table rows, and hide those who don't match the search query
        
              for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[2];
                if (td) {
                  txtValue = td.innerText;
                  if (input.value == "all-sectors") {
                      tr[i].style.display = "";
                  }
                    else if (txtValue.indexOf(filter) > -1) {
                      tr[i].style.display = "";
                    } else {
                      tr[i].style.display = "none";
                    }
                }
              }
            }

      
      function weighting() {
          const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");
          let totalWeight = 0;
            for(var i=1; i < ele.length; i++){
              let td = tr[i].getElementsByTagName("td")[3];
              let price = parseFloat(td.innerText);
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                totalWeight += price;          
        
            }
        document.getElementById("val").innerHTML = "Total weight is: " + totalWeight.toFixed(2);

      }
      
      
      
      
      function selectAll(){  
              var ele=document.getElementsByTagName('input');  
              for(var i=0; i<ele.length; i++){
                /* offsetParent checks if checkbox is currently visible */  
                  if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                      ele[i].checked=true;  
              }  
              weighting();
          }  

       function deSelect(){  
                var ele=document.getElementsByTagName('input'); 
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                        ele[i].checked=false;   
                }  
                weighting();
            }          
      

      function sortTable() {
  var table, rows, switching, i, x, y, shouldSwitch;
  table = document.getElementById("portfolio");
  switching = true;
  /*Make a loop that will continue until
  no switching has been done:*/
  while (switching) {
    //start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /*Loop through all table rows (except the
    first, which contains table headers):*/
    for (i = 2; i < (rows.length - 2); i++) {
      //start by saying there should be no switching:
      shouldSwitch = false;
      /*Get the two elements you want to compare,
      one from current row and one from the next:*/
      x = rows[i].getElementsByTagName("TD")[3];
      y = rows[i + 1].getElementsByTagName("TD")[3];
      //check if the two rows should switch place:
      if (Number(x.innerHTML) > Number(y.innerHTML)) {
        //if so, mark as a switch and break the loop:
        shouldSwitch = true;
        break;
      }
    }
    if (shouldSwitch) {
      /*If a switch has been marked, make the switch
      and mark that a switch has been done:*/
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    }
  }
}


const checkboxes = document.querySelectorAll(".myCheckbox");
const label = document.getElementById("positionCount");

const countPosition = checkboxes.forEach((checkbox) => {
  checkbox.addEventListener("change", () => {
    weighting();
    let total = 0;

    for (let i = 0; i < checkboxes.length; i++) {
      const currentCheckbox = checkboxes[i];
      if (currentCheckbox.checked) {
        total += 1;
      }
    }

    label.innerHTML = "Currently selected number of positions: " + total;
  });
});
    </script>
</html>