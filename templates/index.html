<!DOCTYPE html>
<html>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
 crossorigin="anonymous">

<style>

</style>

<body>
	<h1>Build your custom S&P 500</h1>

	<label>Sectors</label>
          <select id="sector" class="form-control" onchange="filterSector()">
            <option value="all-sectors">All sectors</option>
            <option>Industrials</option>
            <option>Health Care</option>
            <option>Information Technology</option>
            <option>Communication Services</option>
            <option>Consumer Staples</option>
            <option>Consumer Discretionary</option>
            <option>Utilities</option>
            <option>Financials</option>
            <option>Materials</option>
            <option>Real Estate</option>
            <option>Energy</option>
          </select>
          <p></p>
          <label>Search for name</label>
        <input class="form-control" type="text" id="search" onkeyup="searchName()"><p></p>

        <button id="selectAll">Select all</button>
        <button id="removeAll">Remove  all from selection</button><p></p>
        
        <span id="positionCount"></span><p></p>
        <span id="sumOfWeights"></span><p></p>
        <span id="smWeight">Smallest weight: </span><p></p>
        <span id="mrktInvest">Minimum investment with market cap weighting:</span><p></p>
        <span id="eqInvest">Minimum investment with equal weighting:</span><p></p>

        <button id="weightSelection">Calculate custom ETF</button><p></p>
        <button id="toJSON">Generate JSON file</button>

        <table id="portfolio" class="table table-hover table-condensed">
            <thead>
              <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Sector</th>
                  <th>Index weight</th>
                  <th>Custom ETF weight</th>
                  <th>Include in selection</th>
    <!--              <th>Share in selection</th>   -->
              </tr>
            </thead>  
            <tbody>
            <tr>
                {% for row in rows %}
            
               <td>{{row["symbol"]}}</td>
               <td>{{row["name"]}}</td>
               <td>{{row["sector"]}}</td>
               <td>{{row["weight"]}}</td>
               <td></td>
               <td><input type="checkbox" class="myCheckbox" id="include" value="include" checked></td>
    <!--         <td><div class="form-group">
                    <div class="input-group mb-3">
                      <input type="number" class="form-control" aria-label="">
                      <div class="input-group-append">
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div> -->
            </tr>
         {% endfor %}
          </tbody>
        </table>
    </body>
  <script>

      selectAllButton = document.getElementById("selectAll");
      selectAllButton.addEventListener("click", function () {
        selectAll();
        countPosition();
      })

      removeAllButton = document.getElementById("removeAll");
      removeAllButton.addEventListener("click", function () {
        deSelect();
        countPosition();
      })

      toJSONButton = document.getElementById("toJSON");
      toJSONButton.addEventListener("click", function () {
        const table = document.getElementById("portfolio");
        tableToJson(table);
      })

      weightSelectionButton = document.getElementById("weightSelection");
      weightSelectionButton.addEventListener("click", function () {
        let totalWeight = sumUpWeights();
        positionWeight(totalWeight);
        let smallest = smallestWeight();
        let numPositions = countPosition();
        minimumInvestment(smallest, numPositions);

      })
      
      function searchName() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById("portfolio");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      function totalPositions() {
        let table = document.getElementById("portfolio");
        let tr = table.getElementsByTagName("tr");
        let positionCount = document.getElementById("positionCount");
        /* minus 1 for header */
        positionCount.innerHTML = "Currently selected number of positions: " + (tr.length - 1);
      }
      totalPositions();
      
      function filterSector() {
          var input, filter, table, tr, td, i, txtValue;
          input = document.getElementById("sector");
          filter = input.value;
          table = document.getElementById("portfolio");
          tr = table.getElementsByTagName("tr");
          console.log(filter)

          // Loop through all table rows, and hide those who don't match the search query
        
              for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[2];
                if (td) {
                  txtValue = td.innerText;
                  if (input.value == "all-sectors") {
                      tr[i].style.display = "";
                  }
                    else if (txtValue.indexOf(filter) > -1) {
                      tr[i].style.display = "";
                    } else {
                      tr[i].style.display = "none";
                    }
                }
              }
            }

      function sumUpWeights() {
          const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");
          let total = 0;
            for(var i=1; i < ele.length; i++){
              let td = tr[i].getElementsByTagName("td")[3];
              let price = parseFloat(td.innerText);
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                total += price;          
        
            }
        document.getElementById("sumOfWeights").innerHTML = "Total weight: " + total.toFixed(2) + "%";
        return total;
      }
      sumUpWeights();

      function positionWeight(totalWeight) {
        let scalar = 100/totalWeight;
        const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");

            for(var i=1; i < ele.length; i++){
              let index = tr[i].getElementsByTagName("td")[3];
              let custom = tr[i].getElementsByTagName("td")[4];
              let indexWeight = parseFloat(index.innerText);
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                custom.innerText = (indexWeight * scalar).toFixed(2);
              else 
                custom.innerText = 0;         
            }
      }
      
      function selectAll(){  
              var ele=document.getElementsByTagName('input');  
              for(var i=0; i<ele.length; i++){
                /* offsetParent checks if checkbox is currently visible */  
                  if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                      ele[i].checked=true;  
              }  
              sumUpWeights();
              smallestWeight();
          }  

       function deSelect(){  
                var ele=document.getElementsByTagName('input'); 
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                        ele[i].checked=false;   
                }  
                sumUpWeights();
                document.getElementById("smWeight").innerHTML = "Smallest weight: 0.00%"
            }          
      
      const checkboxes = document.querySelectorAll(".myCheckbox");
      const label = document.getElementById("positionCount");

      const eventCheckbox = checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          //sumUpWeights();
          countPosition();
        });
      });

      function countPosition() {
          let total = 0;
          for (let i = 0; i < checkboxes.length; i++) {
            const currentCheckbox = checkboxes[i];
            if (currentCheckbox.checked) {
              total += 1;
            }
          }
          label.innerHTML = "Currently selected number of positions: " + total;
          return total;
      }

      function smallestWeight() {
        let values = [];
        const ele = document.getElementsByTagName('input');
        let table = document.getElementById("portfolio");
        let trs = table.getElementsByTagName("tr");
        for(  i = 0, len = trs.length; i < len; i++ ) {
          if(ele[i].type=='checkbox' && ele[i].checked == true) {
            values.push( parseFloat( trs[ i ].cells[ 4 ].innerHTML ) );
          }
        }
      
      let smallest = Math.min.apply( null, values );
      document.getElementById("smWeight").innerHTML = "Smallest weight: " + smallest.toFixed(2) + "%";
      return smallest;
        }
      
      function minimumInvestment(smallest, numPositions) {
        //let minInvest = 0;
        let scalar = (1 / smallest);
        minInvest = (100-smallest) * scalar + 1;
        
        document.getElementById("mrktInvest").innerHTML = "Minimum investment with market cap weighting: $" + minInvest.toFixed(2);
        document.getElementById("eqInvest").innerHTML = "Minimum investment with equal weighting: $" + numPositions.toFixed(2);
      }

      let table = document.getElementById("portfolio");
    function tableToJson(table) {
    let data = [];
    const ele = document.getElementsByTagName('input');
    // first row needs to be headers
    let headers = [];
    for ( i=0; i<table.rows[0].cells.length; i++) {
        headers[i] = table.rows[0].cells[i].innerHTML.toLowerCase().replace(/ /gi,'');
    }

    // go through cells
    for ( i=1; i<table.rows.length; i++) {
      if(ele[i].type=='checkbox' && ele[i].checked == true) {
        let tableRow = table.rows[i];
        let rowData = {};

        for ( j=0; j<tableRow.cells.length; j++) {

            rowData[ headers[j] ] = tableRow.cells[j].innerHTML;

        }
      
        data.push(rowData);
      }
    }       
    console.log(data);
    return data;
}
    </script>
</html>