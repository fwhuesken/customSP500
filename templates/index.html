<!DOCTYPE html>
<html>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
 crossorigin="anonymous">

<style>

</style>

<body>
<p></p>
<p></p>
<p></p>
<div class="row">
  <div class="col-md-4"></div>
  <div class="col-md-4">
  <h1>Build a custom ETF
    <small class="text-muted">Selected from the S&P 500</small>
  </h1>

	<label>Sectors</label>
          <select id="sector" class="form-control" onchange="filterSector()">
            <option value="all-sectors">All sectors</option>
            <option>Communication Services</option>
            <option>Consumer Discretionary</option>
            <option>Consumer Staples</option>
            <option>Energy</option>
            <option>Financials</option>
            <option>Health Care</option>
            <option>Industrials</option>
            <option>Information Technology</option>
            <option>Materials</option>
            <option>Real Estate</option>
            <option>Utilities</option>
          </select>
  <label>Industries</label>
          <select id="industry" class="form-control" onchange="filterIndustry()">
            <option value="all-industries">All industries</option>
            <option>Advertising</option>
            <option>Aerospace & Defense</option>
            <option>Agricultural & Farm Machinery</option>
            <option>Agricultural Products</option>
            <option>Air Freight & Logistics</option>
            <option>Airlines</option>
            <option>Alternative Carriers</option>
            <option>Apparel Retail</option>
            <option>Apparel, Accessories & Luxury Goods</option>
            <option>Application Software</option>
            <option>Asset Management & Custody Banks</option>
            <option>Auto Parts & Equipment</option>
            <option>Automobile Manufacturers</option>
            <option>Automotive Retail</option>
            <option>Biotechnology</option>
            <option>Brewers</option>
            <option>Broadcasting</option>
            <option>Building Products</option>
            <option>Cable & Satellite</option>
            <option>Casinos & Gaming</option>
            <option>Commodity Chemicals</option>
            <option>Communications Equipment</option>
            <option>Computer & Electronics Retail</option>
            <option>Construction & Engineering</option>
            <option>Construction Machinery & Heavy Trucks</option>
            <option>Construction Materials</option>
            <option>Consumer Electronics</option>
            <option>Consumer Finance</option>
            <option>Copper</option>
            <option>Data Processing & Outsourced Services</option>
            <option>Distillers & Vintners</option>
            <option>Distributors</option>
            <option>Diversified Banks</option>
            <option>Diversified Chemicals</option>
            <option>Diversified Support Services</option>
            <option>Drug Retail</option>
            <option>Electric Utilities</option>
            <option>Electrical Components & Equipment</option>
            <option>Electronic Components</option>
            <option>Electronic Equipment & Instruments</option>
            <option>Electronic Manufacturing Services</option>
            <option>Environmental & Facilities Services</option>
            <option>Fertilizers & Agricultural Chemicals</option>
            <option>Financial Exchanges & Data</option>
            <option>Food Distributors</option>
            <option>Food Retail</option>
            <option>Gas Utilities</option>
            <option>General Merchandise Stores</option>
            <option>Gold</option>
            <option>Health Care Distributors</option>
            <option>Health Care Equipment</option>
            <option>Health Care Facilities</option>
            <option>Health Care REITs</option>
            <option>Health Care Services</option>
            <option>Health Care Supplies</option>
            <option>Health Care Technology</option>
            <option>Home Furnishings</option>
            <option>Home Improvement Retail</option>
            <option>Homebuilding</option>
            <option>Hotel & Resort REITs</option>
            <option>Hotels, Resorts & Cruise Lines</option>
            <option>Household Appliances</option>
            <option>Household Products</option>
            <option>Housewares & Specialties</option>
            <option>Human Resource & Employment Services</option>
            <option>Hypermarkets & Super Centers</option>
            <option>Independent Power Producers & Energy Traders</option>
            <option>Industrial Conglomerates</option>
            <option>Industrial Gases</option>
            <option>Industrial Machinery</option>
            <option>Industrial REITs</option>
            <option>Insurance Brokers</option>
            <option>Integrated Oil & Gas</option>
            <option>Integrated Telecommunication Services</option>
            <option>Interactive Home Entertainment</option>
            <option>Interactive Media & Services</option>
            <option>Internet & Direct Marketing Retail</option>
            <option>Internet Services & Infrastructure</option>
            <option>Investment Banking & Brokerage</option>
            <option>IT Consulting & Other Services</option>
            <option>Leisure Products</option>
            <option>Life & Health Insurance</option>
            <option>Life Sciences Tools & Services</option>
            <option>Managed Health Care</option>
            <option>Metal & Glass Containers</option>
            <option>Movies & Entertainment</option>
            <option>Multi-line Insurance</option>
            <option>Multi-Sector Holdings</option>
            <option>Multi-Utilities</option>
            <option>Office REITs</option>
            <option>Oil & Gas Equipment & Services</option>
            <option>Oil & Gas Exploration & Production</option>
            <option>Oil & Gas Refining & Marketing</option>
            <option>Oil & Gas Storage & Transportation</option>
            <option>Packaged Foods & Meats</option>
            <option>Paper Packaging</option>
            <option>Personal Products</option>
            <option>Pharmaceuticals</option>
            <option>Property & Casualty Insurance</option>
            <option>Publishing</option>
            <option>Railroads</option>
            <option>Real Estate Services</option>
            <option>Regional Banks</option>
            <option>Reinsurance</option>
            <option>Research & Consulting Services</option>
            <option>Residential REITs</option>
            <option>Restaurants</option>
            <option>Retail REITs</option>
            <option>Semiconductor Equipment</option>
            <option>Semiconductors</option>
            <option>Soft Drinks</option>
            <option>Specialized REITs</option>
            <option>Specialty Chemicals</option>
            <option>Specialty Stores</option>
            <option>Steel</option>
            <option>Systems Software</option>
            <option>Technology Distributors</option>
            <option>Technology Hardware, Storage & Peripherals</option>
            <option>Thrifts & Mortgage Finance</option>
            <option>Tobacco</option>
            <option>Trading Companies & Distributors</option>
            <option>Trucking</option>
            <option>Water Utilities</option>
            <option>Wireless Telecommunication Services</option>
          </select>
          <p></p>
          <label>Search for name</label>
        <input class="form-control" type="text" id="search" onkeyup="searchName()"><p></p>

        <button class="btn btn-outline-success" id="selectAll">Select all</button>
        <button class="btn btn-outline-danger" id="removeAll">Remove  all from selection</button><p></p>
        
        <span id="positionCount"></span><p></p>
        <span id="sumOfWeights" style="display:none"></span><p></p>
        <span id="smWeight" style="display:none">Smallest weight: </span><p></p>
        <span id="mrktInvest">Minimum investment with market cap weighting:</span><p></p>
        <span id="eqInvest" style="display:none">Minimum investment with equal weighting:</span><p></p>





        <button id="weightSelection" class="btn btn-outline-secondary btn-block">Calculate current selection</button><p></p>
        <button class="btn btn-success" id="toJSON">Buy</button>
        <!--To hide tag add style="display:none" -->


<p></p>



            </div>
  <div class="col-md-4"></div>
</div>

<div class="row">
  <div class="col-md-1"></div>
  <div class="col-md-10">

        <table id="portfolio" class="table table-hover table-condensed">
            <thead>
              <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Sector</th>
                  <th>Industry</th>
                  <th>Index weight</th>
                  <th>Custom ETF weight</th>
                  <th>Minimum investment</th>
                  <th>Include in selection</th>
    <!--              <th>Share in selection</th>   -->
              </tr>
            </thead>  
            <tbody>
            <tr>
                {% for row in rows %}
            
               <td>{{row["symbol"]}}</td>
               <td>{{row["name"]}}</td>
               <td>{{row["sector"]}}</td>
               <td>{{row["industry"]}}</td>
               <td>{{row["weight"]}}</td>
               <td id="TDcustometfweight"></td>
               <td id="TDminInvest"></td>
               <td><input type="checkbox" class="myCheckbox" id="include" value="include" checked></td>
    <!--         <td><div class="form-group">
                    <div class="input-group mb-3">
                      <input type="number" class="form-control" aria-label="">
                      <div class="input-group-append">
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                  </div> -->
            </tr>
         {% endfor %}
          </tbody>
        </table>
        </div>
  <div class="col-md-1"></div>
</div>
    </body>
  <script>

      selectAllButton = document.getElementById("selectAll");
      selectAllButton.addEventListener("click", function () {
        selectAll();
        countPosition();
      })

      removeAllButton = document.getElementById("removeAll");
      removeAllButton.addEventListener("click", function () {
        deSelect();
        countPosition();
      })

      toJSONButton = document.getElementById("toJSON");
      toJSONButton.addEventListener("click", function () {
        const url = '/data';
        const table = document.getElementById("portfolio");
        const tableData = tableToJson(table);
        fetch(url, {
            method: 'POST',
            headers : { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
       },
            body: JSON.stringify(tableData)
          })
          .then(resp => resp.json())
          //.then(data => console.log(data))
          ;
      })

      weightSelectionButton = document.getElementById("weightSelection");
      weightSelectionButton.addEventListener("click", function () {
        let totalWeight = sumUpWeights();
        positionWeight(totalWeight);
        let smallest = smallestWeight();
        let numPositions = countPosition();
        minimumInvestment(smallest, numPositions);

      })
      
      function searchName() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById("portfolio");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      function totalPositions() {
        let table = document.getElementById("portfolio");
        let tr = table.getElementsByTagName("tr");
        let positionCount = document.getElementById("positionCount");
        /* minus 1 for header */
        positionCount.innerHTML = "Currently selected number of positions: " + (tr.length - 1);
      }
      totalPositions();
      
      function filterSector() {
          var input, filter, table, tr, td, i, txtValue;
          input = document.getElementById("sector");
          filter = input.value;
          table = document.getElementById("portfolio");
          tr = table.getElementsByTagName("tr");
          console.log(filter)

          // Loop through all table rows, and hide those who don't match the search query
        
              for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[2];
                if (td) {
                  txtValue = td.innerText;
                  if (input.value == "all-sectors") {
                      tr[i].style.display = "";
                  }
                    else if (txtValue.indexOf(filter) > -1) {
                      tr[i].style.display = "";
                    } else {
                      tr[i].style.display = "none";
                    }
                }
              }
            }

      function filterIndustry() {
          var input, filter, table, tr, td, i, txtValue;
          input = document.getElementById("industry");
          filter = input.value;
          table = document.getElementById("portfolio");
          tr = table.getElementsByTagName("tr");
          console.log(filter)

          // Loop through all table rows, and hide those who don't match the search query
        
              for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[3];
                if (td) {
                  txtValue = td.innerText;
                  if (input.value == "all-industries") {
                      tr[i].style.display = "";
                  }
                    else if (txtValue.indexOf(filter) > -1) {
                      tr[i].style.display = "";
                    } else {
                      tr[i].style.display = "none";
                    }
                }
              }
            }

      function sumUpWeights() {
          const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");
          let total = 0;
            for(var i=1; i < ele.length; i++){
              let td = tr[i].getElementsByTagName("td")[4];
              let price = parseFloat(td.innerText);
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                total += price;          
        
            }
        document.getElementById("sumOfWeights").innerHTML = "Total weight: " + total.toFixed(2) + "%";
        return total;
      }


      function positionWeight(totalWeight) {
        let scalar = 100/totalWeight;
        const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");

            for(var i=1; i < ele.length; i++){
              let index = tr[i].getElementsByTagName("td")[4];
              let custom = tr[i].getElementsByTagName("td")[5];
              let indexWeight = parseFloat(index.innerText);
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                custom.innerText = (indexWeight * scalar).toFixed(2);
              else 
                custom.innerText = 0;         
            }
      }
      
      function selectAll(){  
              var ele=document.getElementsByTagName('input');  
              for(var i=0; i<ele.length; i++){
                /* offsetParent checks if checkbox is currently visible */  
                  if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                      ele[i].checked=true;  
              }  
              sumUpWeights();
              smallestWeight();
          }  

       function deSelect(){  
                var ele=document.getElementsByTagName('input'); 
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox' && ele[i].offsetParent !== null)  
                        ele[i].checked=false;   
                }  
                sumUpWeights();
                document.getElementById("smWeight").innerHTML = "Smallest weight: 0.00%"
            }          
      
      const checkboxes = document.querySelectorAll(".myCheckbox");
      const label = document.getElementById("positionCount");

      const eventCheckbox = checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          //sumUpWeights();
          countPosition();
        });
      });
//Counts number of selected positions. Used to calculate minimum investment with equal weighting
      function countPosition() {
          let total = 0;
          for (let i = 0; i < checkboxes.length; i++) {
            const currentCheckbox = checkboxes[i];
            if (currentCheckbox.checked) {
              total += 1;
            }
          }
          label.innerHTML = "Currently selected number of positions: " + total;
          return total;
      }
//Find the smallest weight of the selection. Used to calculate minimum investment with market weighting
      function smallestWeight() {
        let values = [];
        const ele = document.getElementsByTagName('input');
        let table = document.getElementById("portfolio");
        let trs = table.getElementsByTagName("tr");
        for(  i = 0, len = trs.length; i < len; i++ ) {
          if(ele[i].type=='checkbox' && ele[i].checked == true) {
            values.push( parseFloat( trs[ i ].cells[ 5 ].innerHTML ) );
          }
        }
      
        let smallest = Math.min.apply( null, values );
        document.getElementById("smWeight").innerHTML = "Smallest weight: " + smallest.toFixed(2) + "%";
        return smallest;
          }

//Takes the smallest weight to calculate minimum investment at market cap weighting. For equal weighting, it uses number of positions in selection * $1
      function minimumInvestment(smallest, numPositions) {
        //let minInvest = 0;
        let scalar = (1 / smallest);
        minInvest = (100-smallest) * scalar + 1;
        
        document.getElementById("mrktInvest").innerHTML = "Minimum investment with market cap weighting: $" + minInvest.toFixed(2);
        document.getElementById("eqInvest").innerHTML = "Minimum investment with equal weighting: $" + numPositions.toFixed(2);

        const ele = document.getElementsByTagName('input');
          let table = document.getElementById("portfolio");
          let tr = table.getElementsByTagName("tr");

            for(var i=1; i < ele.length; i++){
              let custom = tr[i].getElementsByTagName("td")[5];
              let customWeight = parseFloat(custom.innerText);
              let minimum = tr[i].getElementsByTagName("td")[6];
              if(ele[i].type=='checkbox' && ele[i].checked == true)
                minimum.innerText = "$" + (customWeight * scalar).toFixed(2);
              else 
                minimum.innerText = "$0";         
            }

      }
//Turns table into JSON file used by server to trade. Should be triggered by a BUY button
      let table = document.getElementById("portfolio");
      function tableToJson(table) {
      let data = [];
      const ele = document.getElementsByTagName('input');
      // first row needs to be headers
      let headers = [];
      for ( i=0; i<table.rows[0].cells.length; i++) {
          headers[i] = table.rows[0].cells[i].innerHTML.toLowerCase().replace(/ /gi,'');
      }

      // go through cells
      for ( i=1; i<table.rows.length; i++) {
        if(ele[i].type=='checkbox' && ele[i].checked == true) {
          let tableRow = table.rows[i];
          let rowData = {};

          for ( j=0; j<tableRow.cells.length; j++) {

              rowData[ headers[j] ] = tableRow.cells[j].innerHTML;

          }
        
          data.push(rowData);
        }
      }       
      console.log(data);
      return data;
  }




    </script>
</html>